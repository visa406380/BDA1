@startuml
==Cart==

Customer -> MerchantWeb: clicks "Proceed to payment"
MerchantWeb -> Customer: Redirects Customer to checkout page

== payment ==
Customer -> MerchantWeb: Select "Apply Gift Card
MerchantWeb --> Customer: Open "Enter Gift Card" window
Customer -> MerchantWeb: Enters Gift card number, clicks "Apply"
MerchantWeb -> MerchantBO: POST GCRedeem request

==Card Validation==
MerchantBO -> MerchantBO: validates Gift Card number, check invalid card number counter

alt card number invalid

MerchantBO -> MerchantBO: Sets invalid card number counter +1

alt invalid card number counter >=3
MerchantBO --> MerchantWeb: POST GCRedeem negative response
MerchantWeb --> Customer: "Wrong card number" message with "Remaining attempts" = 3-'current counter data'
...15 min...
end

MerchantBO --> MerchantWeb: POST GCRedeem negative response 
MerchantWeb --> Customer: "Wrong card number" message with "Remaining attempts" = 3-'current counter data'
Customer -> MerchantWeb: Enters Gift card number, clicks "Apply"
MerchantWeb -> MerchantBO: POST GCRedeem request
MerchantBO -> MerchantBO: validates Gift Card number, check invalid card number counter

end

==Customer Varification==
MerchantBO -> MerchantBO: Run OTP Auth
MerchantBO -> MerchantBO: Checks OTP counter
MerchantBO -> Customer: Send OTP
MerchantBO -> MerchantWeb: Open "Enter OTP" page
Customer -> MerchantWeb: Enter OTP
MerchantWeb -> MerchantBO: Send OTP for validation
MerchantBO -> MerchantBO: Validate OTP

alt incorrect OTP

MerchantBO -> MerchantBO: Set OTP Counter +1
MerchantBO -> MerchantBO: Run OTP Auth
MerchantBO --> MerchantWeb: incorrect OTP response
MerchantBO -> Customer: Send OTP
MerchantWeb --> Customer: Re-enter OTP message
Customer -> MerchantWeb: Enters OTP

end

MerchantBO -> MerchantBO: cart total price recalculation
MerchantBO --> MerchantWeb: Correct OTP response with final amount

==Final payment==

MerchantWeb --> Customer: Correct OTP response, final amount

alt additional Gift Card

end

Customer -> MerchantWeb: Additional payment method (e.g. Bank card) apply
MerchantWeb -> MerchantBO: Process Bank card authentication and tokenization (via PSP)

alt incorrect payment card 
end

MerchantBO -> MerchantBO: store payment intent data
MerchantBO --> MerchantWeb: Additional payment method ally response
MerchantWeb --> Customer: request "pay" button click
Customer -> MerchantWeb: Click "pay"
MerchantWeb -> MerchantBO: Process payment request
MerchantBO -> MerchantBO: book items in store

alt items unavailable
end

MerchantBO -> MerchantBO: Process Gift Card nomination redemption

alt Gift Card nomination unavailable
end

MerchantBO -> MerchantBO: Process Bank card payment request
MerchantBO -> MerchantBO: Receive Bank card payment response

alt Bank card payment decline response
MerchantBO -> MerchantBO: Process Gift Card nomination redemption reversal
MerchantBO -> MerchantBO: Release booked items in store
end 

MerchantBO -> MerchantBO: Process to delivery
MerchantBO --> MerchantWeb: Payment request response 
MerchantWeb --> Customer: "payment was made" notification
 
@enduml
